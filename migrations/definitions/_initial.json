{"schemas":"DEFINE TABLE OVERWRITE area SCHEMALESS;\n\nDEFINE FIELD OVERWRITE identifier ON area;\nDEFINE FIELD OVERWRITE name ON area;\nDEFINE FIELD OVERWRITE area ON area;\n\nDEFINE TABLE OVERWRITE items TYPE RELATION IN area OUT item;\n\nDEFINE TABLE OVERWRITE game SCHEMALESS\n    PERMISSIONS FOR\n        CREATE, SELECT WHERE $auth,\n        FOR UPDATE, DELETE WHERE created_by = $auth;\n\nDEFINE FIELD OVERWRITE identifier ON game;\nDEFINE FIELD OVERWRITE name ON game;\nDEFINE FIELD OVERWRITE status ON game;\nDEFINE FIELD OVERWRITE day ON game;\nDEFINE FIELD OVERWRITE created_by ON game VALUE $auth READONLY;\n\nDEFINE TABLE OVERWRITE areas TYPE RELATION IN game OUT area ENFORCED;\n\nDEFINE TABLE OVERWRITE item SCHEMALESS;\n\nDEFINE FIELD OVERWRITE identifier ON item;\nDEFINE FIELD OVERWRITE name ON item;\nDEFINE FIELD OVERWRITE item_type ON item;\nDEFINE FIELD OVERWRITE quantity ON item;\nDEFINE FIELD OVERWRITE attribute ON item;\nDEFINE FIELD OVERWRITE effect ON item;\n\nDEFINE TABLE OVERWRITE message;\nDEFINE FIELD OVERWRITE id ON message;\nDEFINE FIELD OVERWRITE source ON message TYPE object;\nDEFINE FIELD OVERWRITE source.type ON message TYPE string;\nDEFINE FIELD OVERWRITE source.value ON message TYPE string;\nDEFINE FIELD OVERWRITE game_day ON message TYPE number;\nDEFINE FIELD OVERWRITE subject ON message TYPE string;\nDEFINE FIELD OVERWRITE timestamp ON message TYPE number;\nDEFINE FIELD OVERWRITE content ON message TYPE string;\n\n-- Define indexes for querying\nDEFINE INDEX OVERWRITE message_timestamp ON message FIELDS timestamp;\nDEFINE INDEX OVERWRITE message_game_day ON message FIELDS game_day;\nDEFINE INDEX OVERWRITE message_source_type ON message FIELDS source.type;\nDEFINE INDEX OVERWRITE message_game_id ON message FIELDS source.value;\n\n-- Helper functions for common queries\nDEFINE FUNCTION OVERWRITE fn::get_messages_by_day($day: number) {\n    RETURN SELECT * FROM message\n    WHERE game_day = $day\n    ORDER BY timestamp;\n};\n\nDEFINE FUNCTION OVERWRITE fn::get_messages_by_source_type($source_type: string) {\n    RETURN SELECT * FROM message\n    WHERE source.type = $source_type\n    ORDER BY timestamp;\n};\n\nDEFINE FUNCTION OVERWRITE fn::get_game_messages_by_game_id($game_id: string) {\n    RETURN SELECT * FROM message\n    WHERE source.type = 'Game'\n    AND source.value = $game_id\n    ORDER BY timestamp;\n};\n\nDEFINE FUNCTION OVERWRITE fn::get_messages_by_game_id($game_id: string) {\n    RETURN SELECT * FROM message\n    WHERE string::starts_with(subject, $game_id)\n    ORDER BY timestamp;\n};\n\nDEFINE FUNCTION OVERWRITE fn::get_messages_by_tribute_id($tribute_id: string) {\n    RETURN SELECT * FROM message\n    WHERE string::contains(subject, $tribute_id)\n    ORDER BY timestamp;\n};\n\nDEFINE TABLE OVERWRITE script_migration SCHEMAFULL\n    PERMISSIONS\n        FOR select FULL\n        FOR create, update, delete NONE;\n\nDEFINE FIELD OVERWRITE script_name ON script_migration TYPE string;\nDEFINE FIELD OVERWRITE executed_at ON script_migration TYPE datetime VALUE time::now() READONLY;\nDEFINE TABLE OVERWRITE summary SCHEMALESS;\nDEFINE FIELD OVERWRITE identifier ON summary;\nDEFINE FIELD OVERWRITE day ON summary;\nDEFINE FIELD OVERWRITE content ON summary;\n\nDEFINE TABLE OVERWRITE summaries TYPE RELATION IN game OUT summary;\n\nDEFINE TABLE OVERWRITE tribute SCHEMALESS;\n\nDEFINE FIELD OVERWRITE identifier ON tribute;\nDEFINE FIELD OVERWRITE status ON tribute;\nDEFINE FIELD OVERWRITE avatar ON tribute;\nDEFINE FIELD OVERWRITE name ON tribute;\nDEFINE FIELD OVERWRITE district ON tribute;\nDEFINE FIELD OVERWRITE area ON tribute;\nDEFINE FIELD OVERWRITE player_name ON tribute;\nDEFINE FIELD OVERWRITE statistics ON tribute;\nDEFINE FIELD OVERWRITE attributes ON tribute;\nDEFINE FIELD OVERWRITE items ON tribute;\n\nDEFINE TABLE OVERWRITE owns TYPE RELATION IN tribute OUT item;\nDEFINE TABLE OVERWRITE playing_in TYPE RELATION IN tribute OUT game ENFORCED;\n\nDEFINE FIELD IF NOT EXISTS email ON TABLE user TYPE string ASSERT $value.is_email();\nDEFINE INDEX IF NOT EXISTS unique_user_email ON TABLE user FIELDS email UNIQUE;\nDEFINE ACCESS OVERWRITE account ON DATABASE TYPE RECORD\n    SIGNUP ( CREATE user SET email = $email, pass = crypto::argon2::generate($pass) )\n    SIGNIN ( SELECT * FROM user WHERE email = $email AND crypto::argon2::compare(pass, $pass) )\n    AUTHENTICATE {\n        IF type::thing(\"token\", $token.jti).revoked = true {\n            THROW \"This token has been revoked\";\n        };\n        INSERT INTO token { id: $token.jti, exp: $token.exp, revoked: false };\n        CREATE audit CONTENT { token: $token.jti, time: time::now() };\n        RETURN $auth;\n    }\n    DURATION FOR TOKEN 30d, FOR SESSION 1h;\n","events":""}